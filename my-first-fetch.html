<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Halo 5 Campaign</title>
    <!------ JQuery --------->
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <!------ BootStrap -------->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

</head>
<body>
<main class="container">
    <div>
        <h3 style="color: whitesmoke">Halo Prologue</h3>
        <button id="play">Play</button>
        <button id="pause">Pause</button>
        <div id="status" style="color:red;">Status: Loading</div>
    </div>
    <div class="input-group mb-3">
        <button class="input-group-text" id="searchGamertag">Search</button>
        <input type="text" class="form-control" placeholder="Gamertag" id="searchSpartan" maxlength="15"/>
    </div>
    <div id="container" class="container d-flex justify-content-evenly flex-wrap">

    </div>
</main>

<script src="js/keys.js"></script>
<script>
    $("body").css({
        "background-image": "url('/pics/halo-5-guardians.jpg')",
        "moz-background-size": "cover"
    });

    document.getElementById("searchGamertag").addEventListener('click', function(){
        let gamerTags = document.getElementById("searchSpartan").value;
        let url = "https://www.haloapi.com/stats/h5/servicerecords/campaign?players=" + gamerTags;
        let encodedUrl = encodeURI(url);

        fetch(encodedUrl, {
            headers: {
                "Ocp-Apim-Subscription-Key": HALO_KEY
            }
        })

            .then(response => response.json())
            .then(data => {
                console.log(data);

                let mainContainer = document.getElementById("container"); //Spartan List container

                for (let p of data.Results) {
                    let d = document.createElement("div"); // Single spartan
                    d.classList.add("card", "col-4", "m-1");
                    d.style.width="18rem";
                    let name = document.createElement("div");
                    name.classList.add("card-header");

                    name.innerHTML = "GamerTag: " + p.Id;

                    function appendingAttribute (parent, content) {
                        let div = document.createElement("div");
                        div.innerHTML = content;
                        parent.appendChild(div);
                    }

                    d.appendChild(name);
                    appendingAttribute(d, "Rank: " + p.Result.SpartanRank);
                    appendingAttribute(d, "XP: " + p.Result.Xp);
                    appendingAttribute(d, "Total Kills: " + p.Result.CampaignStat.TotalKills);
                    appendingAttribute(d, "Total Headshots: " + p.Result.CampaignStat.TotalHeadshots);

                    mainContainer.appendChild(d);
                }
            });
    })

// ******* Fetch Halo Data ***************

            //return;
            /*
            for (var gamer of data.Results) {


                //First call
                let html2 = "";
                let gamerId = (gamer.Id);
                html2 += '<div id="playerTag" style="font-weight: bold">' + "Gamertag: " + gamerId + '</div>';
                $('#playerTag').html(html2);

                //Second call
                console.log(gamer.Result.SpartanRank);
                let html1 = "";
                let sRank = (gamer.Result.SpartanRank);
                let xp = (gamer.Result.Xp);
                html1 += '<div>' + "Spartan Rank: " + sRank + '</div>' +
                    '<div>' + "XP: " + xp + '</div>';
                $('#spartanRank').html(html1);

                //Third call
                console.log(gamer.Result.CampaignStat);
                let html3 = "";
                let stats = (gamer.Result.CampaignStat);
                let totalKills = stats.TotalKills;
                let totalHeadshots = stats.TotalHeadshots;
                console.log(totalKills);
                console.log(totalHeadshots);
                html3 += '<div>' + "Total Kills: " + totalKills + '</div>' +
                    '<div>' + "Total Headshots: " + totalHeadshots + '</div>';
                $('#spartanStats').html(html3);
            }
                */

// *********** Add audio *****************
    let audioElement = document.createElement('audio');
    audioElement.setAttribute('src', '' +
        '/pics/01. Prologue.mp3');

    audioElement.addEventListener('ended', function() {
        this.play();
    }, false);

    audioElement.addEventListener("canplay",function(){
        $("#length").text("Duration:" + audioElement.duration + " seconds");
        $("#source").text("Source:" + audioElement.src);
        $("#status").text("Status: Ready to play").css("color","green");
    });

    $('#play').click(function() {
        audioElement.play();
        $("#status").text("Status: Playing");
    });

    $('#pause').click(function() {
        audioElement.pause();
        $("#status").text("Status: Paused");
    });

</script>
</body>
</html>